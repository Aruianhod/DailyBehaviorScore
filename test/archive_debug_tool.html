<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>归档功能调试测试</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
        }
        .btn {
            background: #2196f3;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        .btn:hover {
            background: #1976d2;
        }
        .btn.danger {
            background: #f44336;
        }
        .btn.danger:hover {
            background: #d32f2f;
        }
        .btn.success {
            background: #4caf50;
        }
        .btn.success:hover {
            background: #388e3c;
        }
        .result {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            margin-top: 10px;
            border-left: 4px solid #2196f3;
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 12px;
        }
        .error {
            border-left-color: #f44336;
            background: #ffebee;
        }
        .success {
            border-left-color: #4caf50;
            background: #e8f5e9;
        }
        .warning {
            border-left-color: #ff9800;
            background: #fff3e0;
        }
        h2 {
            color: #1976d2;
            border-bottom: 2px solid #e3f2fd;
            padding-bottom: 10px;
        }
        .status {
            padding: 10px;
            border-radius: 6px;
            margin: 10px 0;
            font-weight: bold;
        }
        .status.loading {
            background: #e3f2fd;
            color: #1976d2;
        }
        .status.success {
            background: #e8f5e9;
            color: #2e7d32;
        }
        .status.error {
            background: #ffebee;
            color: #c62828;
        }
        input, select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🗃️ 归档功能调试测试工具</h1>
        <p>此工具用于调试和测试归档功能，帮助您理解为什么点击归档后数据没有被删除。</p>
    </div>

    <!-- 步骤1：检查服务器状态 -->
    <div class="container">
        <div class="section">
            <h2>步骤1：检查服务器连接状态</h2>
            <button class="btn" onclick="checkServerStatus()">检查后端服务器</button>
            <div id="serverStatus" class="result"></div>
        </div>
    </div>

    <!-- 步骤2：查看当前数据状态 -->
    <div class="container">
        <div class="section">
            <h2>步骤2：查看当前数据状态</h2>
            <button class="btn" onclick="getArchiveStats()">获取归档统计</button>
            <button class="btn" onclick="getStudents()">查看学生列表</button>
            <div id="dataStatus" class="result"></div>
        </div>
    </div>

    <!-- 步骤3：创建测试数据 -->
    <div class="container">
        <div class="section">
            <h2>步骤3：创建测试数据</h2>
            <p>我们需要一些2020年级的学生来测试归档功能：</p>
            <button class="btn success" onclick="createTestData()">创建2020年级测试学生</button>
            <div id="testDataStatus" class="result"></div>
        </div>
    </div>

    <!-- 步骤4：执行归档操作 -->
    <div class="container">
        <div class="section">
            <h2>步骤4：执行归档操作</h2>
            <p>选择要归档的年级：</p>
            <select id="gradeSelect">
                <option value="2020">2020年级（测试数据）</option>
                <option value="2019">2019年级</option>
                <option value="2018">2018年级</option>
            </select>
            <input type="text" id="archiveReason" placeholder="归档原因" value="测试归档功能">
            <br>
            <button class="btn danger" onclick="executeArchive()">⚠️ 执行归档（删除数据）</button>
            <div id="archiveResult" class="result"></div>
        </div>
    </div>

    <!-- 步骤5：验证结果 -->
    <div class="container">
        <div class="section">
            <h2>步骤5：验证归档结果</h2>
            <button class="btn" onclick="verifyArchiveResult()">验证数据是否被删除</button>
            <button class="btn" onclick="getArchiveLogs()">查看归档历史</button>
            <div id="verificationResult" class="result"></div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:3000/api';
        
        function showStatus(elementId, message, type = 'loading') {
            const element = document.getElementById(elementId);
            element.className = `result ${type}`;
            element.textContent = message;
        }
        
        function showResult(elementId, data, type = 'success') {
            const element = document.getElementById(elementId);
            element.className = `result ${type}`;
            element.textContent = typeof data === 'string' ? data : JSON.stringify(data, null, 2);
        }

        async function checkServerStatus() {
            showStatus('serverStatus', '正在检查服务器状态...');
            try {
                const response = await fetch(`${API_BASE}/admin/archive/stats`);
                if (response.ok) {
                    showResult('serverStatus', '✅ 后端服务器运行正常，归档API可访问', 'success');
                } else {
                    showResult('serverStatus', `❌ 服务器响应错误: ${response.status}`, 'error');
                }
            } catch (error) {
                showResult('serverStatus', `❌ 无法连接到服务器: ${error.message}`, 'error');
            }
        }

        async function getArchiveStats() {
            showStatus('dataStatus', '正在获取归档统计信息...');
            try {
                const response = await fetch(`${API_BASE}/admin/archive/stats`);
                const data = await response.json();
                
                let message = `📊 当前数据状态：
总学生数: ${data.totalStudents}
可归档学生数: ${data.archivableStudents}
可归档记录数: ${data.archivableRecords}
可归档申请数: ${data.archivableApplications}
可归档年级: [${data.graduatedGrades.slice(0, 10).join(', ')}${data.graduatedGrades.length > 10 ? '...' : ''}]
预计节省空间: ${data.estimatedSpaceSaving}`;
                
                showResult('dataStatus', message, 'success');
            } catch (error) {
                showResult('dataStatus', `❌ 获取统计失败: ${error.message}`, 'error');
            }
        }

        async function getStudents() {
            showStatus('dataStatus', '正在获取学生列表...');
            try {
                const response = await fetch(`${API_BASE}/admin/students?grade=2020`);
                const data = await response.json();
                
                let message = `🎓 2020年级学生列表：
学生数量: ${data.students ? data.students.length : 0}`;
                
                if (data.students && data.students.length > 0) {
                    message += `\\n学生详情:\\n`;
                    data.students.forEach(student => {
                        message += `- ${student.name} (学号: ${student.student_id}, 班级: ${student.class}, 分数: ${student.score})\\n`;
                    });
                } else {
                    message += `\\n❌ 没有找到2020年级的学生`;
                }
                
                showResult('dataStatus', message, data.students?.length > 0 ? 'success' : 'warning');
            } catch (error) {
                showResult('dataStatus', `❌ 获取学生列表失败: ${error.message}`, 'error');
            }
        }

        async function createTestData() {
            showStatus('testDataStatus', '正在创建测试数据...');
            try {
                // 这里我们只能模拟创建，实际需要后端API支持
                const students = [
                    { id: '2020000201', name: '测试学生甲', grade: 2020, class: '2001', score: 85 },
                    { id: '2020000202', name: '测试学生乙', grade: 2020, class: '2002', score: 92 },
                    { id: '2020000203', name: '测试学生丙', grade: 2020, class: '2003', score: 78 }
                ];
                
                let message = `✅ 测试数据准备完成！\\n`;
                message += `建议的测试数据（需要手动添加到数据库）：\\n`;
                students.forEach(student => {
                    message += `- ${student.name} (${student.id}) - ${student.grade}级${student.class}班\\n`;
                });
                message += `\\n⚠️ 请确保数据库中有2020年级的学生数据用于测试`;
                
                showResult('testDataStatus', message, 'warning');
                
                // 自动刷新统计
                setTimeout(() => {
                    getArchiveStats();
                }, 1000);
                
            } catch (error) {
                showResult('testDataStatus', `❌ 创建测试数据失败: ${error.message}`, 'error');
            }
        }

        async function executeArchive() {
            const grade = document.getElementById('gradeSelect').value;
            const reason = document.getElementById('archiveReason').value;
            
            if (!reason.trim()) {
                showResult('archiveResult', '❌ 请输入归档原因', 'error');
                return;
            }
            
            // 确认对话框
            if (!confirm(`⚠️ 警告：此操作将永久删除 ${grade} 年级的所有学生数据！\\n\\n这包括：\\n- 学生基本信息\\n- 分数记录\\n- 申请记录\\n\\n此操作不可撤销！\\n\\n确定要继续吗？`)) {
                showResult('archiveResult', '❌ 操作已取消', 'warning');
                return;
            }
            
            showStatus('archiveResult', `正在归档 ${grade} 年级数据...`);
            
            try {
                const response = await fetch(`${API_BASE}/admin/archive/execute`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        grades: [grade],
                        reason: reason
                    })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    let message = `✅ 归档操作成功！\\n`;
                    message += `归档ID: ${result.archiveId}\\n`;
                    message += `删除的学生数: ${result.stats.studentCount}\\n`;
                    message += `删除的记录数: ${result.stats.recordCount}\\n`;
                    message += `删除的申请数: ${result.stats.applicationCount}\\n`;
                    message += `归档的年级: [${result.stats.grades.join(', ')}]`;
                    
                    showResult('archiveResult', message, 'success');
                    
                    // 自动验证结果
                    setTimeout(() => {
                        verifyArchiveResult();
                    }, 2000);
                    
                } else {
                    showResult('archiveResult', `❌ 归档失败: ${result.message}`, 'error');
                }
                
            } catch (error) {
                showResult('archiveResult', `❌ 归档请求失败: ${error.message}`, 'error');
            }
        }

        async function verifyArchiveResult() {
            showStatus('verificationResult', '正在验证归档结果...');
            
            try {
                // 检查归档后的统计
                const statsResponse = await fetch(`${API_BASE}/admin/archive/stats`);
                const stats = await statsResponse.json();
                
                // 检查特定年级的学生
                const studentsResponse = await fetch(`${API_BASE}/admin/students?grade=2020`);
                const students = await studentsResponse.json();
                
                let message = `📋 归档结果验证：\\n`;
                message += `当前总学生数: ${stats.totalStudents}\\n`;
                message += `当前可归档学生数: ${stats.archivableStudents}\\n`;
                message += `2020年级剩余学生数: ${students.students ? students.students.length : 0}\\n\\n`;
                
                if (students.students && students.students.length === 0) {
                    message += `✅ 验证成功：2020年级学生数据已被完全删除！`;
                    showResult('verificationResult', message, 'success');
                } else if (students.students && students.students.length > 0) {
                    message += `⚠️ 警告：2020年级仍有 ${students.students.length} 名学生存在`;
                    message += `\\n剩余学生：\\n`;
                    students.students.forEach(student => {
                        message += `- ${student.name} (${student.student_id})\\n`;
                    });
                    showResult('verificationResult', message, 'warning');
                } else {
                    message += `ℹ️ 无法获取学生数据进行验证`;
                    showResult('verificationResult', message, 'warning');
                }
                
            } catch (error) {
                showResult('verificationResult', `❌ 验证失败: ${error.message}`, 'error');
            }
        }

        async function getArchiveLogs() {
            showStatus('verificationResult', '正在获取归档历史...');
            
            try {
                const response = await fetch(`${API_BASE}/admin/archive/logs`);
                const data = await response.json();
                
                let message = `📚 归档历史记录（最近5条）：\\n`;
                
                if (data.logs && data.logs.length > 0) {
                    data.logs.slice(0, 5).forEach((log, index) => {
                        const date = new Date(log.created_at).toLocaleString('zh-CN');
                        message += `\\n${index + 1}. ID: ${log.id}\\n`;
                        message += `   时间: ${date}\\n`;
                        message += `   年级: [${log.grades_archived.join(', ')}]\\n`;
                        message += `   学生数: ${log.student_count}\\n`;
                        message += `   记录数: ${log.record_count}\\n`;
                        message += `   申请数: ${log.application_count}\\n`;
                        message += `   原因: ${log.archive_reason}\\n`;
                    });
                } else {
                    message += `\\n❌ 没有找到归档记录`;
                }
                
                showResult('verificationResult', message, 'success');
                
            } catch (error) {
                showResult('verificationResult', `❌ 获取归档历史失败: ${error.message}`, 'error');
            }
        }

        // 页面加载时自动检查服务器状态
        window.onload = function() {
            checkServerStatus();
            setTimeout(() => {
                getArchiveStats();
            }, 1000);
        };
    </script>
</body>
</html>
